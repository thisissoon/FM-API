#
# API Deployment
#

# Nginx Config Map
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-api-conf
  labels:
    app: api
    tier: backend
data:
  api.conf: |
    server_tokens                   off;
    client_body_buffer_size         10K;
    client_header_buffer_size       1k;
    client_max_body_size            8m;
    large_client_header_buffers     2 1k;
    client_body_timeout             12;
    client_header_timeout           12;
    send_timeout                    10;
    gzip                            on;
    gzip_comp_level                 6;
    gzip_min_length                 1000;
    gzip_proxied                    expired no-cache no-store private auth;
    gzip_types                      text/plain application/x-javascript text/xml text/css application/xml application/json;
    add_header                      X-Frame-Options "DENY";
    add_header                      X-Content-Type-Options "nosniff";
    add_header                      X-XSS-Protection "1; mode=block";
    server {
        listen 80;
        location / {
            proxy_pass          http://localhost:5000;
            proxy_set_header    Host            $host;
            proxy_set_header    X-Real-IP       $remote_addr;
            proxy_set_header    X-Forwarded-for $remote_addr;
        }
    }
---
# API Environment Variable Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-env-config
  labels:
    app: api
    tier: backend
data:
  SERVER_NAME: api.thisissoon.fm
  REDIS_HOST: redis:6379
  SQLALCHEMY_DB_HOST: cloudsql.default
  CELERY_BROKER_URL: redis://redis:6379/0
---
# Service
apiVersion: v1
kind: Service
metadata:
  name: api
  labels:
    app: api
    tier: backend
spec:
  type: NodePort
  ports:
  - port: 80
  selector:
    app: api
    tier: backend
---
# API Deployment
# Runs Nginx / UWSGI and Celery Workers
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: api
spec:
  replicas: 4
  template:
    metadata:
      labels:
        app: api
        tier: backend
    spec:
      # Volumes
      volumes:
      - name: nginx-config-volume
        configMap:
          name: nginx-api-conf
      # Containers
      containers:
      # Nginx Container
      - name: nginx
        image: nginx:1.10.3-alpine
        resources:
          requests:
            memory: "10Mi"
        volumeMounts:
        - name: nginx-config-volume
          mountPath: /etc/nginx/conf.d
        ports:
        - containerPort: 80
      # # Python API Application
      - name: api
        image: gcr.io/soon-fm-production/api:$TAG
        resources:
          requests:
            memory: "60Mi"
        envFrom:
          - configMapRef:
              name: api-env-config
        env:
          - name: CORS_ACA_ORIGIN
            valueFrom:
              secretKeyRef:
                name: api-cors
                key: origin
          - name: SQLALCHEMY_DB_USER
            valueFrom:
              secretKeyRef:
                name: cloudsql-api-credentials
                key: username
          - name: SQLALCHEMY_DB_PASS
            valueFrom:
              secretKeyRef:
                name: cloudsql-api-credentials
                key: password
          - name: GOOGLE_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: id
          - name: GOOGLE_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: secret
          - name: GOOGLE_REDIRECT_URI
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: redirect
      # Celery Worker
      - name: celery-worker
        image: gcr.io/soon-fm-production/api:$TAG
        resources:
          requests:
            memory: "50Mi"
        command:
          - celery
          - -A
          - fm.tasks.app
          - -l
          - info
          - -c
          - '1'
          - worker
        envFrom:
          - configMapRef:
              name: api-env-config
        env:
          - name: C_FORCE_ROOT
            value: "True"
          - name: SQLALCHEMY_DB_USER
            valueFrom:
              secretKeyRef:
                name: cloudsql-api-credentials
                key: username
          - name: SQLALCHEMY_DB_PASS
            valueFrom:
              secretKeyRef:
                name: cloudsql-api-credentials
                key: password
          - name: GOOGLE_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: id
          - name: GOOGLE_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: secret
          - name: GOOGLE_REDIRECT_URI
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: redirect
---
# Event Listener
# We only ever want to run 1 of these
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: api-eventlistener
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: api
        tier: backend
    spec:
      # Containers
      containers:
      - name: api
        image: gcr.io/soon-fm-production/api:$TAG
        resources:
          requests:
            memory: "70Mi"
        command:
          - python
          - ./manage.py
          - runeventlistener
        envFrom:
          - configMapRef:
              name: api-env-config
        env:
          - name: SQLALCHEMY_DB_USER
            valueFrom:
              secretKeyRef:
                name: cloudsql-api-credentials
                key: username
          - name: SQLALCHEMY_DB_PASS
            valueFrom:
              secretKeyRef:
                name: cloudsql-api-credentials
                key: password
          - name: GOOGLE_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: id
          - name: GOOGLE_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: secret
          - name: GOOGLE_REDIRECT_URI
            valueFrom:
              secretKeyRef:
                name: api-google-oauth
                key: redirect
---
# Migration Job
apiVersion: batch/v1
kind: Job
metadata:
  name: api-db-upgrade-$TAG
spec:
  template:
    metadata:
      labels:
        app: api
        tier: backend
    spec:
      restartPolicy: Never
      containers:
      - name: dbupgrade
        image: gcr.io/soon-fm-production/api:$TAG
        command:
          - python
          - ./manage.py
          - db
          - upgrade
        envFrom:
          - configMapRef:
              name: api-env-config
        env:
          - name: SQLALCHEMY_DB_USER
            valueFrom:
              secretKeyRef:
                name: cloudsql-api-credentials
                key: username
          - name: SQLALCHEMY_DB_PASS
            valueFrom:
              secretKeyRef:
                name: cloudsql-api-credentials
                key: password
